language: generic
dist: trusty
sudo: false
dist: xenial
sudo: false

branches:
  except:
  - ___TGS3TempBranch
  - ___TGSTempBranch

matrix:
  include:
    - env:
      - BUILD_TOOLS=true
      name: "Build Tools"
    - name: "Run Linters"
      addons:
        apt:
          packages:
            - python3
            - python3-pip
            - python3-setuptools
      cache:
        directories:
          - tgui/node_modules
    - env:
      - BUILD_TESTING=true
      - BUILD_TOOLS=false
      name: "Build All Maps"
      install:
        - tools/travis/install_build_tools.sh
      script:
        - tools/travis/check_filedirs.sh beestation.dme
        - tools/travis/build_tools.sh
        - tools/travis/lint_grep.sh

    - name: "Compile All Maps"
      addons:
        apt:
          packages:
            - libstdc++6:i386
      cache:
        directories:
          - $HOME/BYOND
    - env:
      - BUILD_TESTING=false
      - BUILD_TOOLS=false
      name: "Build and Run Unit Tests"
      install:
        - tools/travis/install_byond.sh
        - source $HOME/BYOND/byond/bin/byondsetup
      before_script:
        - tools/travis/template_dm_generator.py
      script:
        - tools/travis/dm.sh -DTRAVISBUILDING -DTRAVISTESTING -DALL_MAPS beestation.dme

    - name: "Compile and Run Tests"
      addons:
        mariadb: '10.2'
        apt:
@@ -51,23 +56,22 @@ matrix:
      cache:
        directories:
          - $HOME/.cargo
          - $HOME/BYOND
          - $HOME/MariaDB
          - $HOME/.rustup

install:
  - tools/travis/install_build_tools.sh
  - if [ $BUILD_TOOLS = false ] && [ $BUILD_TESTING = false ]; then mysql -u root -e 'CREATE DATABASE bee_travis;'; fi
  - if [ $BUILD_TOOLS = false ] && [ $BUILD_TESTING = false ]; then mysql -u root bee_travis < SQL/beestation_schema.sql; fi

before_script:
  - tools/travis/before_build_tools.sh
  - tools/travis/before_build_byond.sh

script:
  - tools/travis/check_filedirs.sh beestation.dme
  - tools/travis/build_tools.sh || travis_terminate 1
  - tools/travis/build_dependencies.sh || travis_terminate 1
  - tools/travis/build_byond.sh
          - $HOME/BYOND
          - $HOME/libmariadb
      install:
        - tools/travis/install_byond.sh
        - source $HOME/BYOND/byond/bin/byondsetup
        - tools/travis/install_libmariadb.sh
        - curl https://sh.rustup.rs -sSf | sh -s -- -y --default-host i686-unknown-linux-gnu
        - source ~/.cargo/env
      before_script:
        - mysql -u root -e 'CREATE DATABASE bee_travis;'
        - mysql -u root bee_travis < SQL/beestation_schema.sql
        - tools/travis/build_rust_g.sh
        - tools/travis/build_bsql.sh
      script:
        - tools/travis/dm.sh -DTRAVISBUILDING beestation.dme || travis_terminate 1
        - tools/travis/run_server.sh
